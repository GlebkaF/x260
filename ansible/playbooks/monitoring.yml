---
# Netdata: web dashboard for server monitoring.
# Install Netdata first (once): curl -sS https://get.netdata.cloud/kickstart.sh | bash -s -- --dont-wait
# Then run: ansible-playbook -i inventory/hosts.yml playbooks/monitoring.yml

- name: Netdata monitoring
  hosts: x260_servers
  become: true
  tasks:
    - name: Check if Netdata is installed
      ansible.builtin.stat:
        path: /etc/netdata/netdata.conf
      register: netdata_conf

    - name: Ensure Netdata config directory exists
      ansible.builtin.file:
        path: /etc/netdata/netdata.conf.d
        state: directory
        mode: "0755"
      when: netdata_conf.stat.exists

    - name: Deploy Netdata web bind config (LAN access on :19999)
      ansible.builtin.copy:
        src: netdata-web-bind.conf
        dest: /etc/netdata/netdata.conf.d/50-web-bind.conf
        mode: "0644"
      when: netdata_conf.stat.exists
      notify: restart netdata

  handlers:
    - name: restart netdata
      ansible.builtin.systemd:
        name: netdata
        state: restarted
